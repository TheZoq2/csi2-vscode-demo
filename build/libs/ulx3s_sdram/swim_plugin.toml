# build_commands = [
#     """[ '${PLUGIN_DIR}/config.yml' -ot '${BUILD_DIR}/litedram/gateware/sdram_controller.v' ] || \
#     python3 \
#         ${PLUGIN_DIR}/litedram/litedram/gen.py \
#         --name sdram_controller \
#         ${PLUGIN_DIR}/config.yml \
#         --output-dir ${BUILD_DIR}/litedram
#     """,
#     """
#     python3 \
#         ${PLUGIN_DIR}/generate_stubs.py \
#         --spade_outdir ${PROJECT_ROOT}/src/generated \
#         ${PROJECT_ROOT}/sdram_config.yml
#     """,
# ]
builds=[]

[commands.litedram_setup]
script = [
    "wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py -O ${BUILD_DIR}/litex_setup.py",
    "chmod +x ${BUILD_DIR}/litex_setup.py",
    "python3 -m venv ${BUILD_DIR}/litedram_venv",
    "mkdir ${BUILD_DIR}/litex",
    ". ${BUILD_DIR}/litedram_venv/bin/activate && cd ${BUILD_DIR}/litex && ../litex_setup.py --init --install",
]
after = "Start"


[commands.litedram_generate]
script = [
    # Make sure litex setup is complete
    """
    [ -f ${BUILD_DIR}/litedram_venv/bin/litedram_gen ] \\
        || (echo 'run swim plugin litedram_setup first' && exit 1) """,
    # Let litex generate its files
    """. ${BUILD_DIR}/litedram_venv/bin/activate && \\
        ${BUILD_DIR}/litedram_venv/bin/litedram_gen \\
            --name sdram_controller_impl \\
            ${PROJECT_ROOT}/dram_config.yml \\
            --output-dir ${BUILD_DIR}/litedram""",
    # Generate Spade stubs
    """
    python3 \
        ${PLUGIN_DIR}/generate_stubs.py \
        --spade_outdir ${PROJECT_ROOT}/src/generated \
        ${PROJECT_ROOT}/dram_config.yml
        """
]
after = "Start"
